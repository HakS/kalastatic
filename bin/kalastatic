#!/usr/bin/env node
'use strict';

/**
 * Module dependencies.
 */

var KalaStatic = require('..')
var program = require('commander')
var nconf = require('nconf')
var path = require('path')
var browserSync = require('browser-sync')

function retrieveConfig(options) {
  nconf.argv()
   .env()
   .file('kalastatic', {
     file: options.config || 'kalastatic.yaml',
     format: require('nconf-yaml')
   })
   .file('package', {
     file: 'package.json'
   })
   return nconf;
}

program
  .version(require('../package.json').version)

program
  .command('build')
  .description('Build in the current working directory, using the given config file.')
  .option('-c, --config <file>', 'set the configuration file, defaults to kalastatic.yaml')
  .action(function (options) {
    var conf = retrieveConfig(options);
    var kalastatic = new KalaStatic(conf);
    kalastatic.build().catch(function (err) {
      console.error(err)
      process.exitCode = 1
    })
  })

program
  .command('start')
  .description('Watch and serve KalaStatic')
  .option('-c, --config <file>', 'set the configuration file, defaults to kalastatic.yaml')
  .action(function (options) {
    var kalastatic = new KalaStatic(retrieveConfig(options));
    var conf = kalastatic.nconf
    var bs = browserSync.create('kalastatic')

    var build = function () {
      kalastatic.build(function () {
        bs.reload()
      }).catch(function (err) {
        console.error(err)
      })
    }

    build();

    var base = conf.get('base') || '.'
    var source = conf.get('source') || 'src'
    var destination = conf.get('destination') || 'build'
    var finalSource = path.join(base, source, '**')
    var finalDest = path.join(base, destination)
    console.log(base, destination,source)

    bs.init({
      server: finalDest,
      index: 'index.html',
      serveStatic: ['.']
    })
    bs.watch(finalSource).on('change', build)
  })

if (!process.argv.slice(2).length) {
  program.outputHelp();
}
else {
  program.parse(process.argv);
}
